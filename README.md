# ğŸ‰ Javaagent ğŸ‰
## æ¦‚è¿°
**javaagent** æ˜¯ä¸€ä¸ªç®€å•ä¼˜é›…çš„ java agent ,åˆ©ç”¨ java è‡ªå¸¦çš„ `instrument` ç‰¹æ€§+ `javassist` å­—èŠ‚ç ç¼–è¾‘æŠ€æœ¯ï¼Œå®ç°äº†æ— ä¾µå…¥çš„æ–¹æ³•çº§æ€§èƒ½ç›‘æ§ã€‚ç›¸æ¯”äºNewRelicæˆ–è€…å¼€æºçš„[pinpoint](https://github.com/naver/pinpoint),ä»¥åŠé˜¿é‡Œçš„[arthas](https://github.com/alibaba/arthas),æœ¬å·¥å…·ä¸»æ‰“çš„æ˜¯ç®€å•ï¼Œæˆ‘ä»¬åªè®°å½•æ¯ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°å’Œæ—¶é—´ï¼Œå¹¶è¾“å‡ºåˆ°jsonæ ¼å¼çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚åŸºäºjavaagentçš„æ—¥å¿—ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸¥ä¸½åŒå­¦å¼€å‘çš„[agentæ—¥å¿—åˆ†æå·¥å…·](https://pan.baidu.com/s/1Ma4iEWRmBonGO1TapeEF-g)è¿›è¡Œåˆ†ææŸ¥è¯¢ï¼Œæˆ–è€…å¯ä»¥è‡ªå·±å»å†™åˆ†æå™¨ï¼Œè¿™æ ·å¯ä»¥è®©ä½ å¿«é€Ÿå®šä½ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½ç“¶é¢ˆã€‚

## é›†æˆ
javaå¯åŠ¨å‚æ•°ä¸­å°±æœ‰javaagent,ä½ åªéœ€è¦åœ¨JAVA_OPTSä¸­åŠ å…¥`-javaagent:/opt/javaagent/javaagent.jar=/opt/javaagent/agent.properties`å°±å®ç°äº†æ–¹æ³•çº§ç›‘æ§ã€‚å…¶ä¸­`=`å‰æŒ‡å®šçš„æ˜¯jaråŒ…çš„è·¯å¾„ï¼Œ`=`åæŒ‡å®šçš„æ˜¯å¯¹agentçš„ä¸€äº›é…ç½®å‚æ•°ã€‚

### agent.propertiesè¯´æ˜
```
# éœ€è¦ç›‘æ§çš„åŒ…ï¼Œå¤šä¸ªåŒ…ç”¨åˆ†å·åˆ†éš”
agent.include.package=com.XXX
# ä¸éœ€è¦ç›‘æ§çš„åŒ…ï¼Œå¤šä¸ªåŒ…ç”¨åˆ†å·åˆ†éš”ã€‚ éœ€è¦ç›‘æ§çš„åŒ…-ä¸éœ€è¦ç›‘æ§çš„åŒ…å°±æ˜¯çœŸæ­£è¦ç›‘æ§çš„åŒ…
agent.exclude.package=
# æ—¥å¿—æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨å¢åŠ æ—¥æœŸåç¼€
agent.log.file=/opt/agent.log
# æ—¥å¿—è¾“å‡ºå‘¨æœŸ
agent.log.interval.seconds=600
# ä¸éœ€è¦ç›‘æ§çš„ç±»çš„æ­£åˆ™è¡¨è¾¾å¼
agent.exclude.class.regex=
# æ˜¯å¦è®°å½•å¹³å‡æ—¶é—´
agent.log.avg.execute.time=false
# è®°å½•æ–¹æ³•çš„è€—æ—¶æ—¶æ˜¯é‡‡ç”¨nanoTime,è¿˜æ˜¯currentTimeMillis,nanoTimeæ›´å‡†ç¡®ï¼Œä½†æ˜¯ä¼šè€—æ—¶ä¸€äº›
agent.log.nano=true
# æ˜¯å¦ç»Ÿè®¡æ–¹æ³•æ‰§è¡Œæ—¶é—´ç™¾åˆ†æ¯”ï¼ŒåŒJMeteræ€§èƒ½æµ‹è¯•ç™¾åˆ†æ¯”è®¡ç®—æ–¹å¼ï¼Œå¦‚æœå¼€å¯é»˜è®¤ä¼šç»Ÿè®¡æœ€å¤§å€¼ã€æœ€å°å€¼
agent.log.stat.execute.time=false
# æ–¹æ³•æ‰§è¡Œæ—¶é—´ç»Ÿè®¡ç™¾åˆ†æ¯”ï¼ˆagent.log.stat.execute.time=trueæ—¶æœ‰æ•ˆï¼‰ï¼Œå¤šé€‰èŒƒå›´[0, 1]ï¼Œä¾‹å¦‚ï¼š0.5,0.9,0.95,0.99
agent.log.stat.execute.time.pct=0.5,0.9,0.95,0.99
```

## agentæ—¥å¿—åˆ†æå™¨ä½¿ç”¨
agentæ—¥å¿—åˆ†æå™¨æ˜¯æˆ‘åŒäº‹ä¸¥ä¸½ä½¿ç”¨SpringBoot+h2æ•°æ®åº“å¼€å‘çš„åˆ†æå·¥å…·ï¼Œé™¤äº†åŸºç¡€åŠŸèƒ½ï¼Œå¯¹äºæœ‰sqlèƒ½åŠ›çš„åŒå­¦ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨[agentæ—¥å¿—åˆ†æå·¥å…·](https://pan.baidu.com/s/1Ma4iEWRmBonGO1TapeEF-g)è‡ªå¸¦çš„[console](http://ip:port/console)ç™»å½•åï¼Œç›´æ¥å†™sqlè¿›è¡Œç»Ÿè®¡ï¼Œä½ å¯ä»¥æŒ‰è‡ªå·±æƒ³è¦çš„ç»´åº¦æ¥è¿›è¡Œå¤„ç†ã€‚
- JDBC URL:   jdbc:h2:mem:~/h2test
- USer Name : sa
- Password : ç©º

ç™»å½•åï¼Œä½ å°±å¯ä»¥å°½æƒ…åœ°å†™ sql å¯¹ç±»ã€æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•°ã€æ‰§è¡Œæ—¶é—´è¿›è¡Œç»Ÿè®¡æŸ¥è¯¢ã€‚

## æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·
- ç¨‹åºå‘˜é˜¿æ°´ 

![ç¨‹åºå‘˜é˜¿æ°´](https://user-images.githubusercontent.com/3361218/116490540-3ae6da80-a8ca-11eb-97b9-5b9f41dc7740.jpg)

